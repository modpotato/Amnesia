# Amnesia - Source of Truth

## Project Overview

Amnesia is a Minecraft server plugin designed for PaperMC and Folia servers that fundamentally alters the crafting experience by shuffling recipe outputs. The plugin provides a deterministic, seed-based shuffling system that transforms standard Minecraft crafting into an unpredictable gameplay mechanic.

## Core Purpose

The plugin exists to create chaos and challenge in the Minecraft crafting system while maintaining reproducibility through seed-based generation. Players experience a fundamentally altered crafting system where the relationship between ingredients and outputs is randomized, requiring experimentation and discovery to understand the new crafting landscape.

## Target Platform

- **Primary Platform**: PaperMC servers (Minecraft 1.21+)
- **Secondary Platform**: Folia servers with full threading support
- **API Version**: Minecraft 1.21
- **Java Version**: Java 21
- **Build System**: Gradle with Kotlin DSL

## Architectural Principles

### Multi-Server Compatibility

The plugin must seamlessly support both traditional PaperMC servers and Folia's regionized threading model. All scheduler operations, task execution, and thread management must adapt dynamically based on the detected server implementation.

### Seed-Based Determinism

All recipe shuffling operations are deterministic and reproducible through seed values. The same seed always produces the same shuffle results, enabling:
- Consistent server experiences across restarts
- Ability to share specific shuffle configurations
- Reproducible testing and debugging
- Challenge/speedrun configurations

### State Persistence

The plugin maintains persistent state across server restarts, preserving:
- Current shuffle state (whether recipes are shuffled)
- Active seed value
- Seed origin (user-set vs randomly generated)
- Last shuffle timestamp
- Timer configuration

### Performance-First Design

Recipe shuffling operations are optimized for minimal server impact through:
- Asynchronous preparation of shuffle data
- Main-thread operations only when required by Bukkit API
- Caching of material lists and recipe data
- Efficient data structures for recipe storage
- Thread-safe operations

## Core Features

### Recipe Shuffling System

The plugin provides two distinct modes for recipe manipulation:

#### Random Item Mode

Replaces each recipe's output with a randomly selected item from the Minecraft item registry. Each recipe output becomes a randomly chosen material, creating complete unpredictability while maintaining recipe input structures.

**Behavior:**
- Original recipe ingredients remain unchanged
- Recipe outputs replaced with random items from available materials
- Uses configurable exclusion list to prevent problematic items
- Each recipe gets an independent random selection

#### Recipe Result Shuffle Mode

Shuffles recipe outputs among existing recipes while maintaining the set of available outputs. This creates a complete permutation of recipe results where no new items are introduced, but the mapping from ingredients to outputs is randomized.

**Behavior:**
- Original recipe ingredients remain unchanged
- Recipe outputs shuffled among all existing recipes
- No new items introduced to the game
- All original craftable items remain craftable

### Seed Management

Seeds are 64-bit long integers that determine the exact shuffle configuration.

**Seed Properties:**
- Can be user-specified for intentional configurations
- Can be randomly generated by the system
- Persist across server restarts
- Track whether user-set or system-generated
- Same seed always produces identical shuffle

### Timer-Based Automatic Reshuffling

The plugin supports automated reshuffling on a configurable interval with player notifications.

**Timer Features:**
- Configurable interval in seconds
- Enable/disable state persists across restarts
- Countdown notifications at configurable intervals
- Automatic seed regeneration (unless user-set seed is active)
- Graceful handling of server restarts mid-timer

### Client Recipe Synchronization

The plugin provides three modes for handling client-side recipe knowledge:

#### Resync Mode
Actively updates clients with the new shuffled recipes, allowing recipe book functionality and client-side crafting hints.

#### Clear Mode
Removes all recipe knowledge from clients, forcing pure experimentation without recipe book assistance.

#### Vanilla Mode
Leaves client recipe management to Minecraft's default behavior without plugin interference.

### Cross-Server Restart Consistency

When the server restarts, the plugin automatically:
- Detects if recipes were previously shuffled
- Re-applies the shuffle using the stored seed
- Restores shuffle state without user intervention
- Maintains timer state and configuration

## Recipe Type Support

The plugin supports all standard Minecraft recipe types:
- Shaped crafting recipes
- Shapeless crafting recipes
- Furnace smelting recipes
- Blast furnace recipes
- Smoker recipes
- Campfire cooking recipes
- Stonecutting recipes

## Configuration System

### Configuration File (config.yml)

The primary configuration file controls plugin behavior and customization:

**Shuffle Settings:**
- Shuffle mode selection (random_item or recipe_result)
- Client synchronization mode (resync, clear, vanilla)

**Timer Settings:**
- Timer interval in seconds
- Timer enabled/disabled state on startup

**Exclusion Lists:**
- Recipe exclusions: specific recipes to never shuffle
- Random item exclusions: items to never select in random_item mode

**Notification System:**
- Notification intervals for countdown messages
- Customizable MiniMessage-formatted notification messages
- Placeholder support for dynamic values

### Data File (data.yml)

Persistent data storage for runtime state:

**Stored Data:**
- Current seed value
- Seed origin flag (user-set vs generated)
- Current shuffle state (shuffled vs original)
- Last shuffle timestamp (milliseconds since epoch)

## Command System

All commands are subcommands of the base `/amnesia` command with permission-based access control.

### Shuffle Command
`/amnesia shuffle [mode] [seed <value>|random]`

Triggers immediate recipe shuffling with optional mode and seed specification. Can change shuffle mode on-the-fly and specify a new seed value.

### Timer Command
`/amnesia timer [enable|disable|interval <seconds>]`

Manages automatic reshuffling timer, including enabling/disabling and adjusting the interval. When the interval is changed while the timer is running, the timer restarts with the new interval.

### Seed Command
`/amnesia seed [view|set <seed>|random]`

Manages the shuffle seed, allowing viewing of the current seed and its origin, setting a specific seed value, or generating a new random seed.

### Reload Command
`/amnesia reload`

Reloads the plugin configuration from disk and applies changes to timer state without requiring a server restart.

## Permission System

Granular permission nodes control access to plugin functionality:

- `amnesia.command` - Base access to amnesia command
- `amnesia.command.shuffle` - Access to shuffle subcommand (default: op)
- `amnesia.command.timer` - Access to timer subcommand (default: op)
- `amnesia.command.seed` - Access to seed subcommand (default: op)
- `amnesia.command.reload` - Access to reload subcommand (default: op)

## Notification System

The plugin uses the Adventure API with MiniMessage formatting for all player-facing messages.

**Notification Types:**
- Countdown messages at configurable intervals before shuffle
- Shuffle start notification
- Shuffle completion notification
- Command feedback messages

**Customization:**
- All messages configurable in config.yml
- MiniMessage format support (colors, formatting, hover, click events)
- Placeholder support for dynamic values (e.g., seconds remaining)

## Technical Architecture

### Component Structure

**Main Plugin Class (Main.java)**
- Plugin lifecycle management
- Manager initialization and coordination
- Folia detection and compatibility handling
- Manager instance access

**Configuration Management (ConfigManager.java)**
- Config file loading and saving
- Configuration value access
- Runtime configuration updates
- Notification message management

**Data Management (DataManager.java)**
- Persistent data storage
- Seed generation and management
- Shuffle state tracking
- Data file operations

**Recipe Management (RecipeManager.java)**
- Recipe storage and retrieval
- Shuffle algorithm implementation
- Recipe registration and removal
- Client synchronization coordination

**Timer Management (TimerManager.java)**
- Automated shuffle scheduling
- Countdown notification system
- Timer lifecycle management
- Cross-platform scheduler handling

**Command Handling (AmnesiaCommand.java)**
- Command parsing and routing
- Permission checking
- Tab completion
- User feedback

### Utility Systems

**Scheduler Utility (SchedulerUtil.java)**
- Platform-agnostic task scheduling
- Folia compatibility layer
- Async task management
- Main thread execution handling

**Message Utility (MessageUtil.java)**
- MiniMessage parsing and formatting
- Message broadcasting
- Placeholder replacement
- Player message delivery

**Recipe Builders (RecipeBuilderFactory.java, RecipeBuilder.java)**
- Recipe type detection and handling
- Recipe cloning with new outputs
- Support for all recipe types
- Factory pattern for extensibility

**Material Cache (MaterialCache.java)**
- Material list caching
- Item material filtering
- Exclusion checking
- Performance optimization

**Recipe Key Utility (RecipeKeyUtil.java)**
- NamespacedKey extraction
- Recipe type checking
- Unified key handling

## Data Flow

### Shuffle Operation Flow

1. Shuffle command issued or timer triggers
2. Current seed retrieved from DataManager
3. Shuffle mode retrieved from ConfigManager
4. Recipe data prepared asynchronously
   - Original recipes stored if first shuffle
   - Shuffled recipes generated based on mode and seed
5. Main thread execution:
   - Server recipes cleared
   - Shuffled recipes registered
   - Client synchronization applied
6. Shuffle state saved to data file
7. Notifications sent to players

### Server Restart Flow

1. Plugin enabled
2. Configuration loaded from config.yml
3. Data loaded from data.yml
4. Recipe manager initialized
5. If shuffle state is true:
   - Recipes re-shuffled using stored seed
   - No player notifications sent
   - Shuffle state restored
6. Timer started if enabled in config

## Design Patterns and Principles

### Factory Pattern
Recipe creation abstracted through RecipeBuilderFactory, allowing extensible support for new recipe types without modifying core logic.

### Singleton Pattern
Plugin managers use singleton access through Main instance for global coordination.

### Strategy Pattern
Shuffle modes implement different algorithms while sharing common infrastructure.

### Dependency Injection
Managers receive plugin instance for access to other managers and configuration.

### Thread Safety
Careful separation of async preparation and main-thread operations ensures thread safety without sacrificing performance.

### Fail-Safe Design
Comprehensive error handling and logging prevents plugin crashes from affecting server stability.

## Exclusion System

### Recipe Exclusions

Specific recipes can be excluded from shuffling by namespaced key. Excluded recipes maintain their original behavior and are not included in shuffle operations.

**Use Cases:**
- Preserve critical recipes (e.g., basic tools)
- Exclude recipes that would break gameplay
- Maintain progression paths

### Random Item Exclusions

Specific items can be excluded from random selection in random_item mode. These items will never be selected as recipe outputs.

**Default Exclusions:**
- minecraft:air
- minecraft:barrier
- minecraft:structure_void
- minecraft:command_block (all variants)
- minecraft:debug_stick
- minecraft:jigsaw
- minecraft:structure_block
- minecraft:knowledge_book

**Purpose:**
- Prevent selection of non-obtainable items
- Avoid items that break game mechanics
- Exclude creative-only items
- Prevent problematic items (e.g., air)

## Notification Timing

Default countdown intervals create increasing urgency:
- 300 seconds (5 minutes)
- 60 seconds (1 minute)
- 30 seconds
- 10 seconds and below (every second)

Messages automatically scale based on configured intervals, with special handling for the final 10-second countdown.

## Future Extensibility

The architecture supports future enhancements:
- Additional shuffle modes through strategy pattern
- New recipe types through factory registration
- Custom notification triggers
- Advanced exclusion rules
- Shuffle history and rollback
- Multi-seed shuffle chains
- Shuffle scheduling and patterns

## Version Management

Version numbers are automatically generated from git commit count during CI builds. Development versions use "INDEV" identifier.

## License

GNU General Public License v3.0 - Free and open-source software with copyleft provisions.

## Author

ModPotato

## Repository

https://github.com/ModPotato/Amnesia

## Compatibility Notes

### Folia Support

Full compatibility with Folia's regionized threading through:
- Dynamic scheduler detection and adaptation
- Global region scheduler usage for timer operations
- Thread-safe recipe management
- Proper async/sync operation separation

### Paper Support

Full compatibility with traditional Paper servers through standard Bukkit scheduler usage.

## Configuration Philosophy

Configuration should be:
- Intuitive and well-documented
- Flexible for various use cases
- Safe with sensible defaults
- Persistent across restarts
- Accessible without code changes

## User Experience Goals

Players should experience:
- Clear communication of shuffle events
- Fair warning before shuffles occur
- Reliable and consistent behavior
- Minimal server performance impact
- Reproducible configurations through seeds

Server administrators should experience:
- Simple installation and setup
- Powerful configuration options
- Reliable operation
- Clear logging and error reporting
- Easy troubleshooting

## Operational Guarantees

The plugin guarantees:
- Same seed produces identical shuffles
- No recipe data loss
- Graceful handling of server restarts
- Proper cleanup on plugin disable
- Thread-safe operations
- No server crashes from plugin errors

## Message Format

All user-facing messages use MiniMessage format, supporting:
- Color tags (`<red>`, `<gold>`, etc.)
- Format tags (`<bold>`, `<italic>`, etc.)
- Nested tags
- Placeholder replacement
- Unicode characters

## Logging Philosophy

Console logging should:
- Report plugin lifecycle events
- Document shuffle operations with seed information
- Warn about configuration issues
- Report errors with stack traces
- Provide debugging information without spam

## Build System

Gradle-based build with:
- Java 21 toolchain requirement
- Paper API as compile-only dependency
- Adventure API for messaging
- Automatic resource filtering for plugin.yml
- Run task for development testing
- Automated CI builds on GitHub Actions
